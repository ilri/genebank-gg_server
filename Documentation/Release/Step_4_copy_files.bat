@ECHO OFF
REM **************************************************************************************************************************
REM main paths
REM **************************************************************************************************************************
set GG=C:\projects\gringlobal
set NONSVN=C:\projects\gringlobal_non-svn
set SERVER=http://grin-global-dev4.agron.iastate.edu/gringlobal/uploads/installers
set LOCALIISDIR=C:\inetpub\wwwroot\gringlobal
set APPVERSION=latest


REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM
REM
REM Clear /gringlobal in IIS, precompile the website (to detect errors)
REM
REM
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************

echo ****************************************************************************
echo ****************************************************************************
echo.
echo Precompiling website, preparing /gringlobal web app in IIS
echo.
echo ****************************************************************************
echo ****************************************************************************


REM ***************************************************************************************************************************
REM Rebuild the solution
REM ***************************************************************************************************************************

call "c:\Program Files\Microsoft Visual Studio 9.0\VC\vcvarsall.bat" x86 

iisreset

REM ***************************************************************************************************************************
REM Publish GrinGlobal.Web to local webserver at /gringlobal vdir
REM ***************************************************************************************************************************
rmdir /s /q "%LOCALIISDIR%\uploads"
aspnet_compiler.exe -nologo -v /gringlobal -p "%GG%\GrinGlobal.Web" -f -u -fixednames "%LOCALIISDIR%"






echo -------------------------------------------
echo %date% %time% Done precompiling and creating web app.
echo -------------------------------------------














REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM
REM
REM Create CD cab file
REM
REM
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************

echo ****************************************************************************
echo ****************************************************************************
echo.
echo Creating CD cab file
echo.
echo ****************************************************************************
echo ****************************************************************************


REM Copy file descriptor file to relative path
copy "%GG%\offline_install.xml" "%NONSVN%\offline_install.xml"
copy "%GG%\Setup.bat" "%NONSVN%\Setup.bat"


REM **************************************************************************************************************************
REM subfolders from main paths
REM **************************************************************************************************************************
set WEBINST=%NONSVN%\web_installer


REM **************************************************************************************************************************
REM cabarc tool from CAB SDK -- http://support.microsoft.com/kb/310618
REM **************************************************************************************************************************

set CABEXE=%NONSVN%\cabsdk\bin\cabarc.exe


REM **************************************************************************************************************************
REM Add in Installers, data cabs, and descriptor file for the local CD cab file
REM **************************************************************************************************************************
del "%WEBINST%\GrinGlobal_CD.cab"
%CABEXE% n "%NONSVN%\GrinGlobal_CD.cab" "%WEBINST%\*.exe" "%WEBINST%\*.msi" "%WEBINST%\*_data.cab" "%WEBINST%\*_search.cab" "%GG%\offline_install.xml" "%GG%\Setup.bat"
move "%NONSVN%\GrinGlobal_CD.cab" "%WEBINST%\GrinGlobal_CD.cab"


echo -------------------------------------------
echo %date% %time% Done creating CD cab file
echo -------------------------------------------








REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM
REM
REM Copy cab files to /gringlobal web app
REM
REM
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************

echo ****************************************************************************
echo ****************************************************************************
echo.
echo Copying cab files to /gringlobal web app
echo.
echo ****************************************************************************
echo ****************************************************************************





REM ***************************************************************************************************************************
REM Copy msi / exe files to version-specific installer path on local webserver (so Updater can locate them after a client downloads them from the local website)
REM ***************************************************************************************************************************
echo %date% %time% Copying setup files and data cab files to local web server...
mkdir "%LOCALIISDIR%\uploads\installers\%APPVERSION%\"
copy "%NONSVN%\web_installer\*.*" "%LOCALIISDIR%\uploads\installers\%APPVERSION%\"

REM ***************************************************************************************************************************
REM Copy Updater msi / exe files to installer path on local webserver (so Updater can locate them after a client downloads them)
REM ***************************************************************************************************************************
echo %date% %time% Copying Updater to download area on local web server...
copy "%NONSVN%\web_installer\GrinGlobal_Updater_Setup.*" "%LOCALIISDIR%\uploads\installers\"


echo -------------------------------------------
echo %date% %time% Done creating CD cab file
echo -------------------------------------------


echo
echo ****************************************************************************
echo ****************************************************************************
echo ****************************************************************************
echo ****************************************************************************
echo ****************************************************************************
echo Check for errors above!
echo If no errors, step 4 is done.
echo ****************************************************************************
pause
