@ECHO OFF



REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM
REM
REM SCRUB DATA FROM DATABASE
REM
REM
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************

REM **************************************************************************************************************************
REM main paths
REM **************************************************************************************************************************
set GG=C:\projects\gringlobal
set NONSVN=C:\projects\gringlobal_non-svn

cd \projects\gringlobal\documentation\release

echo ****************************************************************************
echo ****************************************************************************
echo.
echo Scrubbing unneeded test data from database (lists, settings, etc)
echo.
echo ****************************************************************************
echo ****************************************************************************
for /f %%a IN ('dir /b /s .\sql_scripts\*.sql') do call .\sql_scripts\sqlrunner.bat %%a

echo -------------------------------------------
echo Done scrubbing data
echo -------------------------------------------

REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM
REM
REM EXPORT DATA FROM DATABASE
REM
REM
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************
echo ****************************************************************************
echo ****************************************************************************
echo.
echo Exporting schema and data from database to files...
echo.
echo ****************************************************************************
echo ****************************************************************************

del /q /s /f "%NONSVN%\raw_data_files\*.*"

REM ***************************************************************************************************************************
REM Export data from local database to local folder
REM ***************************************************************************************************************************
"%GG%\GrinGlobal.DatabaseCopier\bin\Debug\GrinGlobal.DataBaseCopier.exe" /export "%NONSVN%\raw_data_files" sqlserver "Data Source=localhost\sqlexpress;Initial Catalog=gringlobal;Trusted_Connection=True" gringlobal

REM ***************************************************************************************************************************
REM Copy exported schema to GrinGlobal.DatabaseCopier.Setup so next rebuild pulls it in
REM ***************************************************************************************************************************
copy "%NONSVN%\raw_data_files\__schema.xml" "%GG%\GrinGlobal.Database.Setup\__schema.xml"

echo -------------------------------------------
echo %date% %time% Done exporting data.
echo -------------------------------------------



REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM
REM
REM CREATE DATABASE CAB FILES
REM
REM
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************

REM **************************************************************************************************************************
REM subfolders from main paths
REM **************************************************************************************************************************
set RAWDATA=%NONSVN%\raw_data_files
set RAWSEARCH=%NONSVN%\raw_search_files
set WEBINST=%NONSVN%\web_installer
set PREREQ=%NONSVN%\preqrequisites_installer


REM **************************************************************************************************************************
REM cabarc tool from CAB SDK -- http://support.microsoft.com/kb/310618
REM **************************************************************************************************************************

set CABEXE=%NONSVN%\cabsdk\bin\cabarc.exe


REM **************************************************************************************************************************
REM System data -- is included in MSI, so copy to svn folder since the installer project directly references it
REM **************************************************************************************************************************
echo ****************************************************************************
echo ****************************************************************************
echo.
echo Creating cab files from database txt files...
echo.
echo ****************************************************************************
echo ****************************************************************************

REM do not package up the user settings tables, those should be empty from the get-go
del %RAWDATA%\app_user_item_list.txt
del %RAWDATA%\sys_user_gui_setting.txt


del %GG%\gringlobal.database.setup\system_data.cab
%CABEXE% n %GG%\gringlobal.database.setup\system_data.cab %RAWDATA%\sys_*.* + %RAWDATA%\cooperator*.* + %RAWDATA%\app_*.* + %RAWDATA%\web_user.* + %RAWDATA%\web_user_preference.* + %RAWDATA%\web_cooperator.* + %RAWDATA%\site.* + %RAWDATA%\region*.* + %RAWDATA%\geo*.* + %RAWDATA%\code*.* 



REM **************************************************************************************************************************
REM All other data is dynamically downloaded, and therefore not included in an MSI.  Just put it in the web installer folder.
REM **************************************************************************************************************************


REM Taxonomy data
del %WEBINST%\taxonomy_data.cab
%CABEXE% n %WEBINST%\taxonomy_data.cab %RAWDATA%\taxonomy*.* + %RAWDATA%\crop.* + %RAWDATA%\citation*.* + %RAWDATA%\literature*.* 

REM Accession / Inventory data
del %WEBINST%\accession_data.cab 
%CABEXE% n %WEBINST%\accession_data.cab %RAWDATA%\accession*.* + %RAWDATA%\inventory*.* + %RAWDATA%\method*.* + %RAWDATA%\site_*.* + %RAWDATA%\name_*.*
REM + %RAWDATA%\web_user_cart*.*

REM Observation data
del %WEBINST%\observation_data.cab 
%CABEXE% n %WEBINST%\observation_data.cab %RAWDATA%\crop_*.* + %RAWDATA%\genetic_*.*

REM Order data
del %WEBINST%\order_data.cab 
%CABEXE% n %WEBINST%\order_data.cab %RAWDATA%\order*.*
REM + %RAWDATA%\web_order*.*

echo -------------------------------------------
echo %date% %time% Done creating database cab files
echo -------------------------------------------


REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM
REM
REM CREATE SEARCH INDEXES
REM
REM
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************

REM ***************************************************************************************************************************
REM Stop search engine if it's going
REM ***************************************************************************************************************************
net stop ggse

REM ***************************************************************************************************************************
REM Use search engine test app to recreate indexes
REM ***************************************************************************************************************************
echo ****************************************************************************
echo ****************************************************************************
echo.
echo Creating search indexes (this will take awhile, no visible progress)...
echo.
echo ****************************************************************************
echo ****************************************************************************
"%GG%\GrinGlobal.Search.Engine.Tester\bin\Debug\GrinGlobal.Search.Engine.Tester.exe" /recreateallenabled

REM ***************************************************************************************************************************
REM Restart search engine if needed
REM ***************************************************************************************************************************
REM net start ggse


echo -------------------------------------------
echo %date% %time% Done creating search indexes
echo -------------------------------------------









REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM
REM
REM CREATE SEARCH ENGINE CAB FILES
REM
REM
REM **************************************************************************************************************************
REM **************************************************************************************************************************
REM **************************************************************************************************************************


REM **************************************************************************************************************************
REM subfolders from main paths
REM **************************************************************************************************************************
set RAWDATA=%NONSVN%\raw_data_files
set WEBINST=%NONSVN%\web_installer
set PREREQ=%NONSVN%\preqrequisites_installer

REM **************************************************************************************************************************
REM Note this path MUST match what is in the GrinGlobal.Search.Engine.Tester\bin\Debug\gringlobal.search.config file!!!
REM **************************************************************************************************************************
set INDEXSOURCE=%ALLUSERSPROFILE%\GRIN-Global\GRIN-Global Search Engine\indexes


REM **************************************************************************************************************************
REM cabarc tool from CAB SDK -- http://support.microsoft.com/kb/310618
REM **************************************************************************************************************************

set CABEXE=%NONSVN%\cabsdk\bin\cabarc.exe


REM **************************************************************************************************************************
REM All search data is dynamically downloaded, and therefore not included in an MSI.  Just put it in the web installer folder.
REM **************************************************************************************************************************

echo ****************************************************************************
echo ****************************************************************************
echo.
echo Creating search engine cab files...
echo.
echo ****************************************************************************
echo ****************************************************************************

REM Accession data
%CABEXE% n %WEBINST%\accession_search.cab "%INDEXSOURCE%\accession*.*" + "%INDEXSOURCE%\geography*.*"

REM Cooperator data
%CABEXE% n %WEBINST%\cooperator_search.cab "%INDEXSOURCE%\cooperator*.*"

REM Observation data
%CABEXE% n %WEBINST%\observation_search.cab "%INDEXSOURCE%\crop_trait_observation*.*"

REM Inventory data
%CABEXE% n %WEBINST%\inventory_search.cab "%INDEXSOURCE%\inventory*.*" + "%INDEXSOURCE%\order_*.*"

REM Taxonomy data
%CABEXE% n %WEBINST%\taxonomy_search.cab "%INDEXSOURCE%\taxonomy*.*"


echo -------------------------------------------
echo %date% %time% Done creating search engine cab files.
echo -------------------------------------------

echo
echo ****************************************************************************
echo ****************************************************************************
echo ****************************************************************************
echo ****************************************************************************
echo ****************************************************************************
echo Check for errors above!
echo If no errors, step 2 is done.
echo ****************************************************************************
pause
